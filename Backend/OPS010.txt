#include <WiFi.h>
#include <HTTPClient.h>
#include <ArduinoJson.h>
#include "DHT.h"

// Definição dos pinos do controlador para as saídas digitais (Y)
#define pin_Y1 13
#define pin_Y2 12
#define pin_Y3 27
#define pin_Y4 26
#define pin_Y5 25
#define pin_Y6 33
#define pin_Y7 32
#define pin_Y8 4 // ATENÇÃO: Conflito com DHTPIN se ambos forem 4. Mude um deles.

// Definição dos pinos do controlador para as entradas digitais (X)
#define pin_X1 15
#define pin_X2 14
#define pin_X3 5
#define pin_X4 18
#define pin_X5 19
#define pin_X6 36
#define pin_X7 39
#define pin_X8 34

// Definição dos pinos para entrada analógica (AI) e saída analógica (AO)
#define pin_AI1 35
#define pin_AO1 23

#define ENTX_pin 2

// ATENÇÃO: Se pin_Y8 e DHTPIN são ambos 4, isso é um conflito!
// Mude um dos pinos. Exemplo: DHTPIN para um pino não usado (como 16).
#define DHTPIN 16 // Exemplo de mudança, verifique a disponibilidade no seu ESP32.
#define DHTTYPE DHT22
DHT dht(DHTPIN, DHTTYPE);

const char* ssid = "SEU_SSID"; // Nome da rede Wi-Fi (SSID) - SUBSTITUA COM O SEU
const char* password = "SUA_SENHA"; // Senha da rede Wi-Fi - SUBSTITUA COM A SUA

// Ajuste a URL para apontar diretamente para o seu script select.php
const char* serverName = "API AQUI;
// Exemplo para o Replit (assumindo que select.php está na raiz do projeto):
// const char* serverName = "https://7c95f24b-c24a-4ab8-b3a9-fe93d0470817-00-94sf2pjnt9rd.riker.replit.dev/select.php";

unsigned long lastTime = 0;
unsigned long timerDelay = 5000; // Intervalo para buscar dados do servidor (5 segundos)

void setup() {
  Serial.begin(115200);

  dht.begin();

  pinMode(pin_X1, INPUT); pinMode(pin_X2, INPUT); pinMode(pin_X3, INPUT); pinMode(pin_X4, INPUT);
  pinMode(pin_X5, INPUT); pinMode(pin_X6, INPUT); pinMode(pin_X7, INPUT); pinMode(pin_X8, INPUT);

  pinMode(pin_Y1, OUTPUT); pinMode(pin_Y2, OUTPUT); pinMode(pin_Y3, OUTPUT); pinMode(pin_Y4, OUTPUT);
  pinMode(pin_Y5, OUTPUT); pinMode(pin_Y6, OUTPUT); pinMode(pin_Y7, OUTPUT); pinMode(pin_Y8, OUTPUT);
  pinMode(ENTX_pin, OUTPUT);

  digitalWrite(pin_Y1, LOW); digitalWrite(pin_Y2, LOW); digitalWrite(pin_Y3, LOW); digitalWrite(pin_Y4, LOW);
  digitalWrite(pin_Y5, LOW); digitalWrite(pin_Y6, LOW); digitalWrite(pin_Y7, LOW); digitalWrite(pin_Y8, LOW);

  ledcSetup(0, 1000, 12);
  ledcAttachPin(pin_AO1, 0);
  ledcWrite(0, 0);

  WiFi.begin(ssid, password);
  Serial.print("Conectando-se ao Wi-Fi...");
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
    Serial.print(".");
  }
  Serial.println("\nConectado ao Wi-Fi.");
  Serial.print("Endereço IP: ");
  Serial.println(WiFi.localIP());
}

void loop() {
  if (millis() - lastTime > timerDelay) {
    lastTime = millis();
    bool dadosValidosEncontrados = false;

    if (WiFi.status() == WL_CONNECTED) {
      HTTPClient http;
      Serial.print("Requisitando dados de: ");
      Serial.println(serverName);
      http.begin(serverName);
      http.setTimeout(10000);

      int httpResponseCode = http.GET();

      if (httpResponseCode > 0) {
        Serial.print("Resposta HTTP: ");
        Serial.println(httpResponseCode);
        String payload = http.getString();
        Serial.println("Payload recebido:");
        Serial.println(payload);

        DynamicJsonDocument doc(2048);
        DeserializationError error = deserializeJson(doc, payload);

        if (error) {
          Serial.print("Falha na desserialização do JSON: ");
          Serial.println(error.f_str());
        } else {
          const char* status = doc["status"];
          if (status && (strcmp(status, "success") == 0 || strcmp(status, "partial_error") == 0)) {
            JsonArray dataArray = doc["data"].as<JsonArray>();

            if (!dataArray.isNull() && dataArray.size() > 0) {
              JsonObject latestRecord = dataArray[dataArray.size() - 1].as<JsonObject>();
              // *** MODIFICAÇÃO AQUI: Verifica pela chave "idPonto" ***
              if (!latestRecord.isNull() && latestRecord.containsKey("idPonto")) {
                dadosValidosEncontrados = true;
                String idPontoValue = latestRecord["idPonto"].as<String>(); // Obtém o valor de "idPonto"
                Serial.println("Dados válidos encontrados. Último 'idPonto': " + idPontoValue);
              } else {
                Serial.println("Array 'data' com registros, mas último registro é inválido ou não contém 'idPonto'.");
              }
            } else {
              Serial.println("Array 'data' está vazio ou nulo no JSON. Nenhum dado para processar.");
            }
          } else {
            Serial.print("Resposta do servidor não foi 'success' ou 'partial_error'. Status: ");
            Serial.println(status ? status : "N/A");
          }
        }
      } else {
        Serial.print("Erro na requisição HTTP: ");
        Serial.println(http.errorToString(httpResponseCode).c_str());
      }
      http.end();
    } else {
      Serial.println("Wi-Fi desconectado.");
    }

    if (dadosValidosEncontrados) {
      digitalWrite(pin_Y1, HIGH);
      Serial.println("Y1 ACIONADO (dados com 'idPonto' presentes e válidos).");
    } else {
      digitalWrite(pin_Y1, LOW);
      Serial.println("Y1 DESLIGADO (sem dados válidos com 'idPonto', erro ou Wi-Fi desconectado).");
    }
  }
}
